# Анализ бинарных файлов с использованием Ghidra

Этот документ содержит пошаговую инструкцию по использованию Ghidra для анализа уязвимого бинарного файла.

## Установка Ghidra

1. Скачайте последнюю версию Ghidra с [официального сайта](https://ghidra-sre.org/)
2. Распакуйте архив в удобное место
3. Убедитесь, что у вас установлена Java 11 или выше
4. Запустите Ghidra из распакованной директории:
   ```
   ./ghidraRun.sh   # для Linux и macOS
   ghidraRun.bat    # для Windows
   ```

## Создание проекта

1. Запустите Ghidra и выберите `File -> New Project`
2. Выберите "Non-Shared Project" и нажмите "Next"
3. Укажите имя проекта (например, "VulnAnalysis") и директорию для проекта
4. Нажмите "Finish" для создания проекта

## Импорт бинарного файла

1. Выберите `File -> Import File`
2. Найдите скомпилированный файл `vuln` и выберите его
3. Оставьте настройки по умолчанию и нажмите "OK"
4. Когда появится диалог "Import Results", нажмите "OK"
5. Дважды щелкните на импортированном файле в проекте для начала анализа

## Анализ бинарного файла

### 1. Обзор декомпилированного кода

1. После открытия файла будет запущен автоматический анализ
2. Дождитесь завершения анализа
3. Перейдите к окну "Symbol Tree" слева
4. Найдите и разверните раздел "Functions"
5. Найдите и выберите функцию `main`
6. В окне декомпилятора (справа) вы увидите восстановленный C-код

### 2. Анализ функции vulnerable

1. Найдите функцию `vulnerable` в дереве символов
2. Выберите функцию, чтобы увидеть ее декомпилированный код
3. Обратите внимание на уязвимое место в коде:
   ```c
   // Uязвимый вызов gets без проверки размера
   gets(local_buffer);
   ```
4. Проанализируйте размер буфера и структуру стека
5. Обратите внимание на расположение локальных переменных и сохраненного адреса возврата

### 3. Поиск функции secret

1. Найдите функцию `secret` в дереве символов
2. Запишите адрес функции (отображается в колонке "Address")
3. Этот адрес понадобится для создания эксплойта

### 4. Анализ стековой структуры

1. В окне функции `vulnerable` обратите внимание на структуру локальных переменных
2. Найдите размер буфера и его расположение относительно сохраненного указателя кадра (EBP)
3. Вычислите расстояние между началом буфера и сохраненным адресом возврата:
   - Размер буфера
   - Расстояние между концом буфера и сохраненным EBP
   - Размер сохраненного EBP (обычно 4 байта)
4. Сумма этих значений даст нам необходимое смещение для эксплойта

### 5. Использование графического представления

1. Перейдите к окну "Listing" (вкладка рядом с декомпилятором)
2. Найдите функцию `vulnerable`
3. Нажмите правую кнопку мыши и выберите "Display Function Graph"
4. Это позволит увидеть графическое представление потока выполнения функции

## Примечания по созданию эксплойта

На основе анализа Ghidra можно определить ключевые параметры для эксплойта:

1. **Адрес функции secret**: Используйте адрес, найденный в дереве символов
2. **Смещение**: Суммарное расстояние от начала буфера до адреса возврата
3. **Архитектура**: Обратите внимание на порядок байтов (little-endian для x86)

## Дополнительный анализ

### Анализ защитных механизмов

1. Выберите `Analysis -> Binary Analysis` в верхнем меню
2. Проверьте результаты различных анализов безопасности
3. Обратите внимание на статус защитных механизмов:
   - Stack Canary Protection
   - Non-executable Stack (NX)
   - Address Space Layout Randomization (ASLR)
   - Position Independent Executable (PIE)

### Поиск строк

1. Выберите `Search -> For Strings` в верхнем меню
2. Просмотрите список строк, содержащихся в бинарном файле
3. Обратите внимание на строки, связанные с функциями `secret` и `vulnerable`

## Сравнение с защищенной версией

Импортируйте и проанализируйте защищенную версию бинарного файла (`vuln_protected`):

1. Сравните декомпилированный код
2. Найдите добавленные проверки для защиты стека (канарейки)
3. Проанализируйте, как изменилась структура стековых фреймов
4. Определите, как эти изменения влияют на возможность эксплуатации

## Заключение

Используя Ghidra, вы можете:
1. Анализировать декомпилированный код уязвимых программ
2. Находить точные адреса функций
3. Изучать структуру стека
4. Определять смещения для создания эксплойтов
5. Анализировать защитные механизмы

Эти навыки критически важны для понимания работы бинарных эксплойтов и разработки средств защиты от них. 