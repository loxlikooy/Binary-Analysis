# Анализ бинарных файлов с использованием IDA Free

Данное руководство описывает процесс анализа уязвимого бинарного файла с использованием бесплатной версии IDA (Interactive Disassembler).

## Установка IDA Free

1. Скачайте IDA Free с [официального сайта](https://hex-rays.com/ida-free/)
2. Установите программу, следуя инструкциям установщика
3. Запустите IDA Free

## Открытие бинарного файла

1. Запустите IDA Free
2. Выберите `File -> Open` или нажмите `Ctrl+O`
3. Найдите и выберите скомпилированный файл `vuln`
4. В диалоговом окне оставьте настройки по умолчанию и нажмите "OK"
5. Дождитесь завершения начального анализа

## Анализ бинарного файла

### 1. Обзор функций

1. Перейдите к окну "Functions window" (View -> Open subviews -> Functions)
2. Здесь вы увидите список всех функций в бинарном файле
3. Найдите функции `main`, `vulnerable` и `secret`
4. Дважды щелкните по функции `main` для переключения к ее ассемблерному коду

### 2. Просмотр ассемблерного кода и графа

1. Для переключения между текстовым и графическим представлением используйте клавишу "Space"
2. В графическом режиме вы увидите блок-схему потока выполнения функции
3. Это помогает визуально анализировать ветвления и циклы

### 3. Анализ функции vulnerable

1. Найдите и перейдите к функции `vulnerable`
2. Изучите ассемблерный код этой функции
3. Обратите внимание на вызов функции `gets`, которая является уязвимой:
   ```assembly
   ; Вызов уязвимой функции gets
   push    eax             ; указатель на буфер
   call    _gets
   add     esp, 4          ; очистка стека
   ```
4. Проанализируйте пролог функции, чтобы определить:
   - Размер выделенного на стеке пространства
   - Расположение локальных переменных
   - Как сохраняется указатель кадра (EBP)

### 4. Поиск адреса функции secret

1. Перейдите к функции `secret` в окне функций
2. Адрес функции отображается в левой части окна или в строке состояния
3. Запишите этот адрес - он понадобится для эксплойта

### 5. Анализ стековой структуры

1. В функции `vulnerable` изучите выделение памяти на стеке (стек растет в сторону уменьшения адресов)
2. Найдите инструкцию `sub esp, XXh`, где XXh - размер выделяемой памяти 
3. Проанализируйте, как организован стековый фрейм:
   - Адрес возврата расположен по адресу `[ebp+4]`
   - Сохраненный EBP расположен по адресу `[ebp]`
   - Локальные переменные расположены по адресам `[ebp-N]`
4. Вычислите смещение от начала буфера до сохраненного адреса возврата

### 6. Использование декомпилятора (при наличии)

В полной версии IDA доступен декомпилятор, который восстанавливает C-код. В IDA Free этот функционал ограничен, но доступен для некоторых процессоров.

## Анализ защитных механизмов

### 1. Проверка на Stack Canary

1. Ищите в прологе и эпилоге функций инструкции, связанные с проверкой "канарейки":
   ```assembly
   mov     eax, large gs:14h   ; загрузка канарейки в регистр
   mov     [ebp-4], eax        ; сохранение канарейки на стеке
   
   ; ... тело функции ...
   
   mov     ecx, [ebp-4]        ; загрузка сохраненной канарейки
   xor     ecx, large gs:14h   ; сравнение с оригинальной канарейкой
   jz      short loc_XXX       ; если равны, все в порядке
   call    ___stack_chk_fail   ; иначе вызов функции обработки ошибки
   ```

2. Отсутствие таких проверок указывает на то, что защита стека отключена

### 2. Проверка на исполняемый стек (NX)

Это можно увидеть в заголовках программы:

1. Выберите `View -> Open subviews -> Headers`
2. Ищите флаги сегментов, указывающие на разрешение выполнения кода в стеке

## Дополнительные функции IDA

### 1. Поиск строк

1. Нажмите `Alt+T` или выберите `Search -> Text...`
2. Введите интересующую вас строку (например, "Access granted")
3. IDA найдет все вхождения этой строки в бинарном файле

### 2. Перекрестные ссылки

1. Выделите имя функции (например, `gets`)
2. Нажмите `X` для просмотра всех вызовов этой функции
3. Это поможет найти все места, где используется уязвимая функция

### 3. Комментирование кода

1. Выделите инструкцию или данные
2. Нажмите `;` для добавления комментария
3. Добавляйте комментарии к важным элементам анализа:
   - Размеру буфера
   - Адресу функции `secret`
   - Вычисленному смещению для эксплойта

## Сравнение с защищенной версией

1. Откройте в отдельном экземпляре IDA защищенную версию (`vuln_protected`)
2. Сравните функцию `vulnerable` в обеих версиях
3. Обратите внимание на добавленные инструкции для проверки канарейки
4. Проанализируйте, как это влияет на возможность эксплуатации

## Применение знаний для создания эксплойта

После анализа в IDA у вас должна быть следующая информация для создания эксплойта:

1. **Адрес функции secret**: Точный адрес, который нужно использовать в эксплойте
2. **Смещение**: Количество байт от начала буфера до адреса возврата
3. **Архитектура**: Порядок байтов (для x86 - little-endian)

## Экспорт и сохранение результатов

1. Для сохранения проанализированного файла выберите `File -> Save`
2. Для экспорта листинга выберите `File -> Produce file -> Create LST file...`
3. Сохраняйте важные адреса и смещения в отдельном файле для использования в эксплойте

## Заключение

IDA Free - мощный инструмент для анализа бинарных файлов, который позволяет:

1. Исследовать ассемблерный код программы
2. Визуализировать поток выполнения с помощью графов
3. Находить уязвимые места в коде
4. Определять адреса функций и смещения для создания эксплойтов
5. Анализировать защитные механизмы

Эти навыки необходимы для понимания работы бинарных эксплойтов и разработки защитных мер против них. 